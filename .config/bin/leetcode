#!/Users/stanleyyo/Python/leetcode/.venv/bin/python3

import argparse
import requests
import html2text
from pathlib import Path
import re
from subprocess import run

WD = Path("/Users/stanleyyo/Python/leetcode")
WD_MD = Path(
    "/Users/stanleyyo/Library/CloudStorage/"
    "GoogleDrive-maximilianstanleyyo1@gmail.com/My Drive/YY/SE/Leetcode"
)
HELP_TEXT = """
usage: get_leetcode.py [-h] [-e] [number]

Fetch LeetCode problem

positional arguments:
  number      LeetCode problem number

options:
  -h, --help  show this help message and exit
  -e, --edit  Edit get_leetcode.py
"""
PROBLEMS_LIST_URL = "https://leetcode.com/api/problems/all/"
GRAPHQL_URL = "https://leetcode.com/graphql/"
HEADERS = {"Content-Type": "application/json"}
FOOTER = """pass

sol = Solution()
res = sol.{method}()
print(res)
"""

def get_slug(problem_number: int) -> str | None:
    """Fetch slug based on problem number"""
    data = requests.get(PROBLEMS_LIST_URL).json()
    for q in data["stat_status_pairs"]:
        if q["stat"]["frontend_question_id"] == problem_number:
            return q["stat"]["question__title_slug"]

    return None

def fetch_problem_data(slug: str):
    """Fetch problem details using GraphQL"""
    query = """
    query getQuestion($titleSlug: String!) {
      question(titleSlug: $titleSlug) {
        title
        content
        codeSnippets {
          lang
          code
        }
      }
    }
    """
    payload = {"query": query, "variables": {"titleSlug": slug}}
    r = requests.post(GRAPHQL_URL, json=payload, headers=HEADERS)
    q = r.json()["data"]["question"]

    return q["title"], q["content"], q["codeSnippets"]

def html_to_body(html: str) -> str:
    """Convert HTML to body"""
    h = html2text.HTML2Text()
    h.ignore_links = False
    h.ignore_images = False
    body = h.handle(html)

    # clean body
    body = re.sub("(\n){2,3}", "\n", body) # normalise \n
    body = re.sub("    \n", "", body)
    body = re.sub("  ", "", body) # 2-space to no indent
    return body

def get_python_template(snippets):
    """Extract Python snippet code"""
    
    for snippet in snippets:
        if snippet["lang"] == "Python3" or snippet["lang"] == "Pandas":
            code = snippet["code"]

            # get method name and format
            method_pattern = re.compile(r"def\s+([a-zA-Z_]\w*)\s*\(")
            match = method_pattern.search(code)
            method_name = match.group(1) if match else "method"
            code += FOOTER.format(method=method_name)
            return code
        
    return "class Solution:\n    pass\n"

def save_body(num: int, slug: str, title: str, body: str, code: str) -> None:
    """Save body and code to .py file and markdown in obsidian"""
    filename = WD / f"{num}-{slug}.py"
    url = f"https://leetcode.com/problems/{slug}/"

    # save to .py file
    with open(filename, "w", encoding="utf-8") as f:
        f.write("'''\n")
        f.write(f"{num}. {title}\n")
        f.write(f"URL: {url}\n\n")
        f.write(body)
        f.write("'''\n\n")
        f.write(code)

    # save to .md file
    with open(WD_MD / f"Leetcode {num} - {title}.md", "w") as f:
        f.write(f"URL: {url}\n\n")
        f.write("```python\n")
        f.write("'''\n")
        f.write(body)
        f.write("'''\n\n")
        f.write(code)
        f.write("```\n")
    
    print(f"ğŸ“„ Templates saved: {filename.stem}")
    print(f"ğŸ”— URL: {url}")

def main():
    parser = argparse.ArgumentParser(description="Fetch LeetCode problem")
    parser.add_argument("number", type=int, help="LeetCode problem number")
    args = parser.parse_args()

    number = args.number
    if not number:
        print(f"âŒ Please input a problem number\n{HELP_TEXT}")
        return
    if number < 1:
        print("âŒ Not a valid problem number.")
        return
    
    # Check if already exists
    if list(WD.glob(f"{number}-*.py")):
        print(f"ğŸ“„ A file for problem {number} already exists.")
        return

    # Get slug
    print(f"ğŸ” Fetching problem {number}...")
    slug = get_slug(number)
    if slug is None:
        print("âŒ Problem not found.")
        return

    # Fetch problem details
    title, html, snippet = fetch_problem_data(slug)
    body = html_to_body(html)
    python_code = get_python_template(snippet)

    # Save .py + .md file and open
    save_body(number, slug, title, body, python_code)

if __name__ == "__main__":
    main()
